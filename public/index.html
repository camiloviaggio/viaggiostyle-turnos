<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ViaggioStyle | Turnos</title>

<style>
body {
  background: #0f0f0f;
  color: #fff;
  font-family: Arial, sans-serif;
  margin: 0;
}

header {
  text-align: center;
  font-size: 30px;
  padding: 25px;
  font-weight: bold;
}

.container {
  max-width: 420px;
  margin: auto;
  background: #1a1a1a;
  padding: 25px;
  border-radius: 16px;
}

label {
  display: block;
  margin-top: 15px;
}

input, select {
  width: 100%;
  padding: 14px;
  margin-top: 6px;
  border-radius: 10px;
  border: none;
  font-size: 16px;
}

#horarios {
  margin-top: 15px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
  gap: 10px;
  opacity: 0;
  transform: translateY(20px)
  transition: all 0.4s ease;
}

.hora-btn {
  padding: 12px;
  border-radius: 10px;
  background: #333;
  color: #fff;
  border: none;
  cursor: pointer;
}

.hora-btn.active {
  background: #fff;
  color: #000;
}

.hora-btn.ocupado {
  background: #555;
  color: #999;
  cursor: not-allowed;
}

button {
  width: 100%;
  padding: 16px;
  margin-top: 20px;
  border-radius: 14px;
  border: none;
  font-size: 17px;
  cursor: pointer;
}
</style>
</head>

<body>

<header>VIAGGIOSTYLE</header>

<div class="container">

<label>Nombre</label>
<input id="nombre">

<label>Servicio</label>
<select id="servicio">
  <option value="">Seleccionar</option>
  <option>Corte</option>
  <option>Corte + Barba</option>
</select>

<label>DÃ­a</label>
<input type="date" id="fecha">

<label>Horario</label>
<div id="horarios"></div>

<button onclick="reservar()">Confirmar turno</button>

</div>

<script>
  const nombre = document.getElementById("nombre");
const servicio = document.getElementById("servicio");

const backend = "https://viaggiostyle-turnos.onrender.com";
const horariosDiv = document.getElementById("horarios");
const fechaInput = document.getElementById("fecha");
let horaSeleccionada = "";

fechaInput.addEventListener("change", generarHorarios);

function hoyISO() {
  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  return hoy.toISOString().split("T")[0];
}

fechaInput.min = hoyISO();

function generarHorarios() {
  horariosDiv.innerHTML = "";
  horariosDiv.style.opacity = 0;
  horaSeleccionada = "";

  const dia = new Date(fechaInput.value + "T00:00").getDay();

  if (dia === 0) {
    horariosDiv.innerHTML = "<div>Los domingos no trabajamos</div>";
    mostrarHorarios();
    return;
  }

  let horas = [];

  if ([1,2,4].includes(dia)) {
    horas = [
      "09:00","09:30","10:00","10:30","11:00","11:30","12:00","12:30","13:00",
      "15:00","15:30","16:00","16:30","17:00","17:30","18:00","18:30","19:00","19:30","20:00"
    ];
  }

  if ([3,5].includes(dia)) {
    horas = [
      "09:00","09:30","10:00","10:30","11:00","11:30","12:00","12:30",
      "13:00","13:30","14:00","14:30","15:00","15:30","16:00","16:30"
    ];
  }

  if (dia === 6) {
    for (let h = 9; h <= 20; h++) {
      horas.push(`${String(h).padStart(2,"0")}:00`);
      if (h !== 20) horas.push(`${String(h).padStart(2,"0")}:30`);
    }
  }

  horas.forEach(hora => {
    const b = document.createElement("button");
    b.className = "hora-btn";
    b.textContent = hora;
    b.onclick = () => {
      document.querySelectorAll(".hora-btn").forEach(x => x.classList.remove("active"));
      b.classList.add("active");
      horaSeleccionada = hora;
    };
    horariosDiv.appendChild(b);
  });

  bloquearOcupados();
  mostrarHorarios();
}

function mostrarHorarios() {
  setTimeout(() => {
    horariosDiv.style.opacity = 1;
    horariosDiv.style.transform = "translateY(0)";
  }, 50);
}

async function bloquearOcupados() {
  const res = await fetch(`${backend}/turnos?fecha=${fechaInput.value}`);
  const turnos = await res.json();

  document.querySelectorAll(".hora-btn").forEach(btn => {
    const ocupado = turnos.find(t => t.hora === btn.textContent && !t.disponible);
    if (ocupado) {
      btn.classList.add("ocupado");
      btn.onclick = null;
    }
  });
}

async function reservar() {
  if (!horaSeleccionada) {
    alert("SeleccionÃ¡ un horario");
    return;
  }

  const res = await fetch(`${backend}/reservar`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      nombre: nombre.value,
      servicio: servicio.value,
      fecha: fechaInput.value,
      hora: horaSeleccionada
    })
  });

  const data = await res.json();

if (!res.ok) {
  alert(data.mensaje || "Error al reservar turno");
  return;
}

alert(data.mensaje);

function generarHorarios() {
  horarios.innerHTML = "";
  horaSeleccionada = "";

  if (!fecha.value) return;

  const dia = new Date(fecha.value + "T00:00:00").getDay();

  // Domingo
  if (dia === 0) {
    horarios.innerHTML = "<div style='color:#888'>Los domingos no trabajamos</div>";
    return;
  }

  // Lunes, martes y jueves
  if (dia === 1 || dia === 2 || dia === 4) {
    generarBloque("09:00", "13:00");
    generarBloque("15:00", "20:00");
  }

  // MiÃ©rcoles y viernes
  if (dia === 3 || dia === 5) {
    generarBloque("09:00", "16:30");
  }

  // SÃ¡bado
  if (dia === 6) {
    generarBloque("09:00", "20:00");
  }

  actualizarTurnos(); // ðŸ”‘ clave
}

function generarBloque(inicio, fin) {
  let [h, m] = inicio.split(":").map(Number);
  let [hf, mf] = fin.split(":").map(Number);

  while (h < hf || (h === hf && m <= mf)) {
    const hora = `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}`;

    const btn = document.createElement("button");
    btn.className = "hora-btn";
    btn.textContent = hora;

    btn.onclick = () => {
      document.querySelectorAll(".hora-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      horaSeleccionada = hora;
    };

    horarios.appendChild(btn);

    m += 30;
    if (m === 60) { m = 0; h++; }
  }
}

</script>

</body>
</html>